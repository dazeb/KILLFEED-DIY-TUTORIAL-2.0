require("dotenv").config();let{SlashCommandBuilder,hyperlink}=require("@discordjs/builders"),{Client,Intents,MessageEmbed}=require("discord.js"),{GUILDID,TOKEN}=require("../config.json"),fs=require("fs"),path=require("path"),readline=require("readline"),ini=require("ini");var config=ini.parse(fs.readFileSync("./config.ini","utf-8"));let axios=require("axios"),moment=require("moment-timezone"),Tail=require("tail").Tail,bot=new Client({intents:[Intents.FLAGS.GUILDS,Intents.FLAGS.GUILD_MESSAGES,Intents.FLAGS.GUILD_MEMBERS]}),logFile="./logs/log.ADM",options={separator:/[\r]{0,1}\n/,fromBeginning:!1,useWatchFile:!0,flushAtEOF:!0,fsWatchOptions:{},follow:!0,nLines:!1,logger:console},tail=new Tail(logFile,options);var linkLoc=" ";let locationNotificationChannelId=config.alrmChan,allLocationsChannelId=config.locChan,definedLocation={x:5400,y:8500,z:330},radius=100;function calculateDistance(e,i){var o=e.x-i.x,n=e.y-i.y,e=e.z-i.z;return Math.sqrt(o*o+n*n+e*e)}function parsePlayerLocation(e){e=e.match(/(\d{2}:\d{2}:\d{2}) \| Player "(.+?)" \(id=.*? pos=<(.+?), (.+?), (.+?)>\)/);return e?{timestamp:e[1],name:e[2],position:{x:parseFloat(e[3]),y:parseFloat(e[4]),z:parseFloat(e[5])}}:null}async function sendNotification(e,i){var o=bot.channels.cache.get(e);o?await o.send({embeds:[i]}):console.error(`Channel ${e} not found`)}tail.on("line",async e=>{1===parseInt(config.mapLoc)?linkLoc="https://www.izurvive.com/livonia/#location=":2===parseInt(config.mapLoc)?linkLoc="https://www.izurvive.com/sakhal/#location=":0===parseInt(config.mapLoc)&&(linkLoc="https://www.izurvive.com/#location=");var i,o,e=parsePlayerLocation(e);e&&(i=`${e.position.x};${e.position.y};`+e.position.z,o=linkLoc+i,i=hyperlink(i,o),o=(new MessageEmbed).setColor("0x00FF00").setTitle("Player Location Update").setDescription(`üïõ**${e.timestamp}**  :bust_in_silhouette:**${e.name}** was pinged at üìç`+i).setTimestamp(),await sendNotification(allLocationsChannelId,o),(i=calculateDistance(e.position,definedLocation))<=radius)&&(o=(new MessageEmbed).setColor("0xFF0000").setTitle("Player Nearby").setDescription(`üïõ**${e.timestamp}**, :bust_in_silhouette:**${e.name}** is within **${i.toFixed(2)+"m"}** of Zone.`).setTimestamp(),await sendNotification(locationNotificationChannelId,o))}),tail.on("error",e=>{console.error("Error reading log file:",e)}),bot.login(TOKEN).catch(e=>{console.log(e)}),bot.on("ready",()=>{console.log("LOCATION MONITORING IS ACTIVE!")}),bot.on("error",e=>{console.log(e)});