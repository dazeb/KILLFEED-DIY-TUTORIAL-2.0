require("dotenv").config();let{SlashCommandBuilder,hyperlink}=require("@discordjs/builders"),fs=require("fs"),ini=require("ini"),{Client,Intents,MessageEmbed}=require("discord.js"),nodeoutlook=require("nodejs-nodemailer-outlook"),axios=require("axios"),path=require("path"),Tail=require("tail").Tail,readline=require("readline"),colors=require("colors"),moment=require("moment-timezone");var config=ini.parse(fs.readFileSync("./config.ini","utf-8")),admRegex=null,admPlat=null;let{GUILDID,PLATFORM,ID1,ID2,NITRATOKEN,REGION}=require("../config.json"),bot=new Client({intents:[Intents.FLAGS.GUILDS,Intents.FLAGS.GUILD_MESSAGES,Intents.FLAGS.GUILD_MEMBERS]}),logFile="./logs/log.ADM",options={separator:/[\r]{0,1}\n/,fromBeginning:!1,useWatchFile:!0,flushAtEOF:!0,fsWatchOptions:{},follow:!0,nLines:!1,logger:console},tail=new Tail(logFile,options),logStats=0,logBytes=0,logSize=0,logSizeRef=0,lineCount=0,lineRef=0,dt0=0,valueRef=new Set,iso,linkLoc=" ",kfChannel=" ",logDt=" ",dt=new Date,todayRef=" ",today=" ",feedStart=!1,phrases=[") killed by ","AdminLog started on ","from",">) bled out",") with (MeleeFist)",">) committed suicide","[HP: 0] hit by FallDamage",") was teleported from:"];async function handleClearCommand(e){var n=e.guildId;if(n&&n===GUILDID){n=e.options.getInteger("value");if(100<n)return e.reply("The max number of messages you can delete is 100").catch(console.error);await e.channel.bulkDelete(n).catch(console.error),await e.reply("clearing messages...").catch(console.error),await e.deleteReply().catch(console.error)}}async function handleMapChange(e){var n=e.guildId;n&&n===GUILDID&&(config=ini.parse(fs.readFileSync("./config.ini","utf-8")),"cherno"===(n=e.options.getString("new-map"))?(config.mapLoc=0,fs.writeFileSync("./config.ini",ini.stringify(config,{mapLoc:"0"})),e.reply("Killfeed Map set to **Chernaus**").catch(function(e){console.log(e)})):"livonia"===n?(config.mapLoc=1,fs.writeFileSync("./config.ini",ini.stringify(config,{mapLoc:"1"})),e.reply("Killfeed Map set to **Livonia**").catch(function(e){console.log(e)})):"sakhal"===n&&(config.mapLoc=2,fs.writeFileSync("./config.ini",ini.stringify(config,{mapLoc:"2"})),e.reply("Killfeed Map set to **Sakhal**").catch(function(e){console.log(e)})))}async function handleSetupCommand(e){var n=e.guildId;n&&n===GUILDID&&(await e.channel.send("....").catch(console.error),kfChannel=e.guild.channels.cache.find(e=>e.name.includes("‚ûñ„ÄãüíÄ-killfeed")),locChannel=e.guild.channels.cache.find(e=>e.name.includes("‚ûñ„ÄãüëÄ-locations")),alarmChannel=e.guild.channels.cache.find(e=>e.name.includes("‚ûñ„Äãüö®-alarm")),null==kfChannel?(await e.guild.channels.create("‚ûñ„ÄãüíÄ-killfeed",{type:"text",permissionOverwrites:[{id:e.guild.roles.everyone,allow:["VIEW_CHANNEL","SEND_MESSAGES","READ_MESSAGE_HISTORY"],deny:["ADMINISTRATOR"]}]}).catch(console.error),await setfeed("kfChan",kfChannel.id).catch(function(e){console.log(e)}),await e.channel.send("Killfeed Channel Created Successfully!").catch(console.error)):(await e.channel.send("Skipped Creating Killfeed Channel!").catch(console.error),await setfeed("kfChan",kfChannel.id).catch(function(e){console.log(e)}),console.log(""+kfChannel)),null==locChannel?(await e.guild.channels.create("‚ûñ„ÄãüëÄ-locations",{type:"text",parent:parentCategory,permissionOverwrites:[{id:everyoneRole,deny:["VIEW_CHANNEL"]}]}).catch(function(e){console.log(e)}),await setfeed("locChan",locChannel.id).catch(function(e){console.log(e)}),await e.channel.send("Locations Channel Created Successfully!").catch(function(e){console.log(e)})):(await e.channel.send("Skipped Creating Locations Channel!").catch(function(e){console.log(e)}),await setfeed("locChan",locChannel.id).catch(function(e){console.log(e)}),console.log(""+locChannel)),null==alarmChannel?(await e.guild.channels.create("‚ûñ„Äãüö®-alarm",{type:"text",parent:parentCategory,permissionOverwrites:[{id:adminRoleId,allow:["VIEW_CHANNEL","SEND_MESSAGES","READ_MESSAGE_HISTORY"],deny:["ADMINISTRATOR"]}]}).catch(function(e){console.log(e)}),await setfeed("alrmChan",alarmChannel.id).catch(function(e){console.log(e)}),await e.channel.send("Alarm Channel Created Successfully!").catch(function(e){console.log(e)})):(await e.channel.send("Skipped Creating Alarm Channel!").catch(function(e){console.log(e)}),await setfeed("alrmChan",alarmChannel.id).catch(function(e){console.log(e)}),console.log(""+alarmChannel)),setTimeout(async()=>{await e.channel.bulkDelete(4).catch(console.error)},5e3),await e.reply("...").catch(console.error),await e.deleteReply().catch(console.error))}async function handleStopCommand(e){var n=e.guildId;n&&n===GUILDID&&feedStart?(await e.reply("Terminating Project.....").catch(console.error),setTimeout(()=>process.exit(22),5e3)):await e.reply("THE KILLFEED IS NOT CURRENTLY RUNNING!.....").catch(console.error)}async function handleDeathlocCommand(e){var n=e.guildId;n&&n===GUILDID&&feedStart?(n=e.options.getString("state"),config.showLoc="on"===n?1:0,fs.writeFileSync("./config.ini",ini.stringify(config)),await e.reply(`Death Locations **${"on"===n?"Enabled":"Disabled"}!**`).catch(console.error)):await e.reply("THE KILLFEED IS NOT CURRENTLY RUNNING!.....").catch(console.error)}async function handleStartCommand(e){var n=e.guildId;n&&n===GUILDID&&(kfChannel=e.guild.channels.cache.find(e=>e.name.includes("‚ûñ„ÄãüíÄ-killfeed")))&&(feedStart?await e.channel.send("THE KILLFEED IS ALREADY RUNNING!.....TRY RESETING IF YOU NEED TO RESTART").catch(console.error):(await e.reply("**Starting Killfeed....**").catch(console.error),feedStart=!0,getDetails(e).catch(console.error)))}async function getDetails(o){tail.on("line",async n=>{var e;lineCount++,lineRef=lineCount,n.includes(phrases[1])&&(logDt=n.slice(20,30),console.log("This is the logDate: "+logDt),console.log("This is the current date: "+todayRef)),phrases.some(e=>n.includes(e)&&e!=phrases[1])&&(e=n,valueRef.has(e)||(valueRef.add(e),iso=n.split(/[|"'<>]/),await handleKillfeedNotification(o)))}),tail.on("error",console.error),setInterval(async()=>{if(feedStart){today=moment().tz(getTimezone()).format(),todayRef=today.slice(0,10);try{logResponse=axios.get("https://api.nitrado.net/services/"+ID1+"/gameservers/file_server/list?dir=/games/"+ID2+admPlat,{responseType:"application/json",headers:{Authorization:"Bearer "+NITRATOKEN,Accept:"application/json"}}).then(e=>{200<=e.status&&e.status<300?downloadLogFile(e.data):console.log(e)})}catch(e){console.error(e)}var e=readline.createInterface({input:fs.createReadStream("./logs/serverlog.ADM")});e.on("line",async e=>{e=e.split(/[|"'<>()]/)[11];try{var n=await axios.get(e);fs.writeFile("./logs/log.ADM",n.data,"utf-8",e=>{if(e)throw e;console.log("Log Saved!")})}catch(e){console.error(e)}}),e.on("close",function(e){return e}),e.on("error",console.error),lineCount=0,logStats=fs.statSync("./logs/log.ADM"),logBytes=logStats.size,logSize=logBytes/1e6,console.log(`Current Log Size: ${logSize} / LogRef Size: ${logSizeRef}
Current LineRef: `+lineRef),logSize<logSizeRef?setTimeout(()=>{logSizeRef=0,valueRef.clear()},4e4):logSizeRef=logSize}else o.guild.channels.cache.get(""+config.kfChan).send("**K1llfeed Paused....**")},35e3)}async function handleKillfeedNotification(e){if(iso){var n,o,a,i,t,l,s,c,r,d,g,f=iso[iso.length-1].slice(2);Date.now();if(iso[9]&&iso[5].includes(phrases[0]))if(f.includes(phrases[2]))try{f.split(" ");var h,m,p=iso[4].toString().split(/[|" "<(),>]/),u=iso[8].toString().split(/[|" "<(),>]/),S=f,w=`${p[0]};${p[2]};`+p[4],y=(u[0],iso[0].toString()),C=iso[6].toString(),D=iso[2].toString();(1===config.showLoc?(h=pvpEmbed(y,C,D,S,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[h],files:["./images/crown.png"]})):(m=pvpEmbed(y,C,D,S),e.guild.channels.cache.get(config.kfChan).send({embeds:[m],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}else try{f.split(" "),p=iso[4].toString().split(/[|" "<(),>]/),u=iso[8].toString().split(/[|" "<(),>]/),S=f,w=`${p[0]};${p[2]};`+p[4],u[0],y=iso[0].toString(),C=iso[6].toString(),D=iso[2].toString(),(1===config.showLoc?(o=pvpEmbed(y,C,D,S,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[o],files:["./images/crown.png"]})):(a=pvpEmbed(y,C,D,S),e.guild.channels.cache.get(config.kfChan).send({embeds:[a],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}else if(!iso[6]&&iso[5].includes(phrases[0]))try{y=iso[0].toString(),C=iso[2].toString(),D=f,n=iso[iso.length-2].split(/[|" "<(),>]/),x1=n[0],y1=n[2],z1=n[4],w=x1.concat(`;${y1};`+z1),(1===config.showLoc?(i=pvpEmbed(y,C,D,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[i],files:["./images/crown.png"]})):(t=pvpEmbed(y,C,D),e.guild.channels.cache.get(config.kfChan).send({embeds:[t],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}else if(f.includes("Spawning"))try{teleportEmbed(e,y=iso[0].toString(),C=iso[2].toString(),D=f)}catch(e){console.error(e)}else if(f.includes("bled out"))try{y=iso[0].toString(),C=iso[2].toString(),D=f,n=iso[iso.length-2].split(/[|" "<(),>]/),x1=n[0],y1=n[2],z1=n[4],w=x1.concat(`;${y1};`+z1),(1===config.showLoc?(l=pveEmbed(y,C,D,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[l],files:["./images/crown.png"]})):(s=pveEmbed(y,C,D),e.guild.channels.cache.get(config.kfChan).send({embeds:[s],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}else if(f.includes("hit by FallDamage"))try{y=iso[0].toString(),C=iso[2].toString(),D="fell to their death",n=iso[iso.length-3].split(/[|" "<(),>]/),x1=n[0],y1=n[2],z1=n[4],w=x1.concat(`;${y1};`+z1),(1===config.showLoc?(c=pveEmbed(y,C,D,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[c],files:["./images/crown.png"]})):(r=pveEmbed(y,C,D),e.guild.channels.cache.get(config.kfChan).send({embeds:[r],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}else if(f.includes("committed suicide"))try{y=iso[0].toString(),C=iso[2].toString(),D=f,n=iso[iso.length-2].split(/[|" "<(),>]/),x1=n[0],y1=n[2],z1=n[4],w=x1.concat(`;${y1};`+z1),(1===config.showLoc?(d=pveEmbed(y,C,D,w),e.guild.channels.cache.get(config.kfChan).send({embeds:[d],files:["./images/crown.png"]})):(g=pveEmbed(y,C,D),e.guild.channels.cache.get(config.kfChan).send({embeds:[g],files:["./images/crown.png"]}))).catch(console.error)}catch(e){console.error(e)}}}function pveEmbed(e,n,o,a){var i=hyperlink("Sign-up for DayZero","https://thecodegang.com"),e=(new MessageEmbed).setColor("0xDD0000").setTitle("Killfeed Notification").setThumbnail("attachment://crown.png").setDescription(e+` **${n}** `+o).addFields({name:"Get Your Free Killfeed!",value:""+i,inline:!1});return a&&e.addFields({name:"üåê",value:""+linkLoc+a,inline:!1}),e}function pvpEmbed(e,n,o,a,i){var t=hyperlink("Sign-up for DayZero","https://thecodegang.com"),e=(new MessageEmbed).setColor("0xDD0000").setTitle("Killfeed Notification").setThumbnail("attachment://crown.png").setDescription(e+` **${n}** Killed **${o}** `+a).addFields({name:"Get Your Free Killfeed!",value:""+t,inline:!1});return i&&e.addFields({name:"üåê",value:""+linkLoc+i,inline:!1}),e}function teleportEmbed(e,n,o,a){n=(new MessageEmbed).setColor("0xDD0000").setTitle("Teleport Notification").setThumbnail("attachment://crown.png").setDescription(n+` **${o}** `+a);e.guild.channels.cache.get(config.teleFeed).send({embeds:[n],files:["./images/crown.png"]}).catch(function(e){console.log(e)})}function getLocation(e){return e?e.split(/[|" "<(),>]/).join(";"):null}function getTimezone(){switch(REGION.toUpperCase()){case"FRANKFURT":return"Europe/Berlin";case"LOS ANGELES":return"America/Los_Angeles";case"LONDON":return"Europe/London";case"MIAMI":case"NEW YORK":return"America/New_York";case"SINGAPORE":return"Asia/Singapore";case"SYDNEY":return"Australia/Sydney";case"MOSCOW":return"Europe/Moscow";default:return"UTC"}}async function downloadLogFile(e){let n,o,a;if(PLATFORM.match(/XBOX|xbox|Xbox/i)){admRegex=/^DayZServer_X1_x64_(\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2})\.ADM$/;var i=await getLatestADMEntry(e);if(!i)return console.log("Unable to determine logfile name!");n="https://api.nitrado.net/services/",o="/gameservers/file_server/download?file=/games/",a="/noftp/dayzxb/config/"+i.name}else if(PLATFORM.match(/PLAYSTATION|PS4|PS5|playstation|Playstation/i)){admRegex=/^DayZServer_X1_x64_(\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2})\.ADM$/;i=await getLatestADMEntry(e);if(!i)return console.log("Unable to determine logfile name!");n="https://api.nitrado.net/services/",o="/gameservers/file_server/download?file=/games/",a="/noftp/dayzps/config/"+i.name}else{admRegex=/^DayZServer_X1_x64_(\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2})\.ADM$/;i=await getLatestADMEntry(e);if(!i)return console.log("Unable to determine logfile name!");n="https://api.nitrado.net/services/",o="/gameservers/file_server/download?file=/games/",a="/ftproot/dayzstandalone/config/"+i.name}e=path.resolve("./logs","serverlog.ADM");let t=fs.createWriteStream(e);return(await axios.get(""+n+ID1+o+ID2+a,{responseType:"stream",headers:{Authorization:"Bearer "+NITRATOKEN,Accept:"application/octet-stream"}})).data.pipe(t),new Promise((e,n)=>{t.on("finish",e),t.on("error",n)})}async function getLatestADMEntry(e){if(!e||"object"!=typeof e||!e.data||!Array.isArray(e.data.entries))throw new Error("Invalid JSON structure!");let n=null,o=null;for(var a of e.data.entries){var i,t;"file"===a.type&&"string"==typeof a.name&&((i=a.name.match(admRegex))&&(t=i[1].replace(/[-_]/g,""),null===o||t>o))&&(o=t,n=a)}return n}async function setfeed(e,n){"kfChan"==e&&(config.kfChan=""+n),"locChan"==e&&(config.locChan=""+n),"alrmChan"==e&&(config.alrmChan=""+n),fs.writeFileSync("./config.ini",ini.stringify(config,{name:""+n})),console.log(e+" Channel Set!")}admPlat="XBOX"==PLATFORM||"Xbox"==PLATFORM||"xbox"==PLATFORM?"/noftp/dayzxb/config":"PLAYSTATION"==PLATFORM||"PS4"==PLATFORM||"PS5"==PLATFORM||"playstation"==PLATFORM||"Playstation"==PLATFORM?"/noftp/dayzps/config":"/ftproot/dayzstandalone/config",1===parseInt(config.mapLoc)?linkLoc="https://www.izurvive.com/livonia/#location=":2===parseInt(config.mapLoc)?linkLoc="https://www.izurvive.com/sakhal/#location=":0===parseInt(config.mapLoc)&&(linkLoc="https://www.izurvive.com/#location="),module.exports={data:(new SlashCommandBuilder).setName("admin").setDescription("Contains all Admin Killfeed commands").setDefaultMemberPermissions("0").addSubcommandGroup(e=>e.setName("killfeed").setDescription("Admin Killfeed Commands").addSubcommand(e=>e.setName("stop").setDescription("Kill Project")).addSubcommand(e=>e.setName("deathloc").setDescription("Toggle on display of death locations in Killfeed notifications").addStringOption(e=>e.setName("state").setDescription("Select desired Alarm state").setRequired(!0).addChoices({name:"OFF",value:"off"},{name:"ON",value:"on"}))).addSubcommand(e=>e.setName("start").setDescription("Start Killfeed")).addSubcommand(e=>e.setName("clear").setDescription("Clear channel messages (limit 100)").addIntegerOption(e=>e.setName("value").setDescription("Enter new value").setRequired(!0))).addSubcommand(e=>e.setName("map").setDescription("Toggle Killfeed Mission Map").addStringOption(e=>e.setName("new-map").setDescription("Select Map to be displayed in notifications").setRequired(!0).addChoices({name:"Chernarus",value:"cherno"},{name:"Livonia",value:"livonia"},{name:"Sakhal",value:"sakhal"}))).addSubcommand(e=>e.setName("setup").setDescription("Set up Discord channels required by Killfeed"))),async execute(e){var n=e.options.getSubcommand();switch(config=ini.parse(fs.readFileSync("./config.ini","utf-8")),n){case"clear":await handleClearCommand(e);break;case"map":await handleMapChange(e);break;case"setup":await handleSetupCommand(e);break;case"stop":await handleStopCommand(e);break;case"deathloc":await handleDeathlocCommand(e);break;case"start":await handleStartCommand(e)}}},console.log(`
.&&@@@%#%/   `.white,"      .,**,******,,,*,".red,"   .*#####(  (###(,".yellow,`
,@@@@@@@@@@@@@.   `.white," ,*********. .**.".red,"   .###### .####".yellow,`
,@@@@@@@@@@@@@@@   `.white," ******      *".red,"         /##,######,".yellow,`
,@@@@@%   &@@@@@&   `.white,"      .******.".red,"    .############.".yellow,`
   @@@@@@@@@@@@@@/   `.white,"    .******".red,"      .###########.".yellow,`
 %@@@@@*   &@@@@@%   `.white,"   *******".red,"       .############,".yellow,`
 #@@@@@* ,@@@@@@@   `.white,"  *******".red,"         .######.######,".yellow,`
 #@@@@@@@&%.%@@#   `.white," ******.   ,,.,".red,"      *#####  ######*".yellow,`
 #@@@@.*    (   `.white,"  .*****. ,*,**,,*".red,"          ##   ######/".yellow),console.log(`
This is dt: `+dt);
