let fs=require("fs"),path=require("path"),SlashCommandBuilder=(require("dotenv").config(),require("@discordjs/builders")).SlashCommandBuilder,{Client,Intents,MessageEmbed}=require("discord.js"),{GUILDID,ID1,NITRATOKEN}=require("../config.json"),ini=require("ini"),axios=require("axios"),FormData=require("form-data"),concat=require("concat-stream"),logFiles=["./logs/ban.txt","./logs/priority.txt","./logs/whitelist.txt"],bot=(logFiles.forEach(e=>{fs.existsSync(e)||fs.writeFileSync(e,"")}),new Client({intents:[Intents.FLAGS.GUILDS,Intents.FLAGS.GUILD_MESSAGES,Intents.FLAGS.GUILD_MEMBERS]}));async function handleWhitelistCommand(e){var t,a=e.guildId;a&&a===GUILDID&&(a=e.options.getString("gamertag"),"add"===(t=e.options.getString("action"))?await addToList("./logs/whitelist.txt",a,"whitelist",e):"remove"===t&&await removeFromList("./logs/whitelist.txt",a,"whitelist",e))}async function handleBanlistCommand(e){var t,a=e.guildId;a&&a===GUILDID&&(a=e.options.getString("gamertag"),"add"===(t=e.options.getString("action"))?await addToList("./logs/ban.txt",a,"bans",e):"remove"===t&&await removeFromList("./logs/ban.txt",a,"bans",e))}async function handlePriorityCommand(e){var t,a=e.guildId;a&&a===GUILDID&&(a=e.options.getString("gamertag"),"add"===(t=e.options.getString("action"))?await addToList("./logs/priority.txt",a,"priority",e):"remove"===t&&await removeFromList("./logs/priority.txt",a,"priority",e))}async function handleGetlistCommand(t){var e=t.guildId;if(e&&e===GUILDID){let e="";switch(t.options.getString("action")){case"wl":e="./logs/whitelist.txt";break;case"ban":e="./logs/ban.txt";break;case"pl":e="./logs/priority.txt"}e&&await getList(e,t)}}async function handleResetlistCommand(a){var e=a.guildId;if(e&&e===GUILDID){let t=a.options.getString("action"),e="";switch(t){case"wl":e="./logs/whitelist.txt";break;case"ban":e="./logs/ban.txt";break;case"pl":e="./logs/priority.txt"}e&&fs.truncate(e,e=>{(e?a.reply("Reset Failed!"):a.reply(t.charAt(0).toUpperCase()+t.slice(1)+" list reset successfully!")).catch(console.error)})}}async function addToList(e,t,a,i){var s=new FormData;let r={...s.getHeaders(),"Content-Length":s.getLengthSync(),Authorization:"Bearer "+NITRATOKEN},n=`https://api.nitrado.net/services/${ID1}/gameservers/settings`;fs.appendFileSync(e,t+`\r
`);t=await streamToString(fs.createReadStream(e,{flags:"r"},"utf8"));s.append("category","general"),s.append("key",a),s.append("value",t),s.pipe(concat(async e=>{try{var t=await axios.post(n,e,{headers:r,withCredentials:!0});200<=t.status&&t.status<300&&i.reply("Request success!").catch(console.error)}catch(e){console.error(e),i.reply("Something went wrong!").catch(console.error)}}))}async function removeFromList(e,t,a,i){var s=new FormData;let r={...s.getHeaders(),"Content-Length":s.getLengthSync(),Authorization:"Bearer "+NITRATOKEN},n=`https://api.nitrado.net/services/${ID1}/gameservers/settings`;t=fs.readFileSync(e,"utf-8").replace(t+`\r
`,""),fs.writeFileSync(e,t,"utf-8"),t=fs.createReadStream(e,{flags:"r"},"utf8"),e=await streamToString(t);s.append("category","general"),s.append("key",a),s.append("value",e),s.pipe(concat(async e=>{try{var t=await axios.post(n,e,{headers:r,withCredentials:!0});200<=t.status&&t.status<300&&i.reply("Request success!").catch(console.error)}catch(e){console.error(e),i.reply("Something went wrong!").catch(console.error)}}))}async function getList(e,t){e=await streamToString(fs.createReadStream(e,{flags:"r"},"utf8"));t.channel.send("Retrieving List....").catch(console.error),t.channel.send(e).catch(console.error),t.channel.send("**Done!**").catch(console.error),t.reply("...").catch(console.error),t.deleteReply().catch(console.error)}function streamToString(a){let i=[];return new Promise((e,t)=>{a.on("data",e=>i.push(e)),a.on("error",t),a.on("end",()=>e(Buffer.concat(i).toString("utf8")))})}module.exports={data:(new SlashCommandBuilder).setName("ac").setDescription("Contains all Access Control commands").addSubcommandGroup(e=>e.setName("serverlist").setDescription("Edit Nitrado Server Access Lists").addSubcommand(e=>e.setName("whitelist").setDescription("Add or Remove GamerTag to Whitelist").addStringOption(e=>e.setName("gamertag").setDescription("Enter a GamerTag").setRequired(!0)).addStringOption(e=>e.setName("action").setDescription("Select desired whitelisting action: Add or Remove").setRequired(!0).addChoices({name:"ADD",value:"add"},{name:"REMOVE",value:"remove"}))).addSubcommand(e=>e.setName("banlist").setDescription("Add or Remove GamerTag to Banlist").addStringOption(e=>e.setName("gamertag").setDescription("Enter a GamerTag").setRequired(!0)).addStringOption(e=>e.setName("action").setDescription("Select desired action").setRequired(!0).addChoices({name:"ADD",value:"add"},{name:"REMOVE",value:"remove"}))).addSubcommand(e=>e.setName("priority").setDescription("Add or Remove GamerTag to Priority List").addStringOption(e=>e.setName("gamertag").setDescription("Enter a GamerTag").setRequired(!0)).addStringOption(e=>e.setName("action").setDescription("Select desired action").setRequired(!0).addChoices({name:"ADD",value:"add"},{name:"REMOVE",value:"remove"}))).addSubcommand(e=>e.setName("getlist").setDescription("Download Current Specified Nitrado Server Access List").addStringOption(e=>e.setName("action").setDescription("Select desired list").setRequired(!0).addChoices({name:"Whitelist",value:"wl"},{name:"Banlist",value:"ban"},{name:"Priority",value:"pl"}))).addSubcommand(e=>e.setName("resetlist").setDescription("Reset Specified Nitrado Server Access List").addStringOption(e=>e.setName("action").setDescription("Select which list will be reset").setRequired(!0).addChoices({name:"Whitelist",value:"wl"},{name:"Banlist",value:"ban"},{name:"Priority",value:"pl"})))),async execute(e){switch(e.options.getSubcommand()){case"whitelist":await handleWhitelistCommand(e);break;case"banlist":await handleBanlistCommand(e);break;case"priority":await handlePriorityCommand(e);break;case"getlist":await handleGetlistCommand(e);break;case"resetlist":await handleResetlistCommand(e)}}};
